<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tilcara Legends | Control de Pagos</title>
  <meta name="description" content="Control de pagos de jugadores por club">

  <link rel="icon" type="image/png" href="https://i.ibb.co/nN8LPTjD/logo-verde.png" />
  <meta name="theme-color" content="#084D1F">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <style>
    /* ===== Reset y base ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: "Montserrat", sans-serif; background: #F5F6F2; color: #084D1F; display:flex; flex-direction:column; align-items:center; width:100%; padding:0 10px; }
    h1,h2,h3,h4 { text-align:center; margin:5px 0; }

    /* ===== Portada ===== */
    .portada { display:flex; justify-content:center; align-items:center; width:100%; margin:0 auto; padding:10px 0; }
    .portada img { max-width:100%; width:auto; height:auto; display:block; border-radius:0 0 12px 12px; }

    /* ===== Loader ===== */
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:#084D1F; display:flex; justify-content:center; align-items:center; flex-direction:column; z-index:9999; }
    #loader img { width:120px; height:auto; animation:pulse 1.5s infinite ease-in-out; }
    #loader p { color:#F5F6F2; margin-top:20px; font-size:1.2rem; font-weight:600; letter-spacing:1px; }
    @keyframes pulse { 0%{transform:scale(1);opacity:1;} 50%{transform:scale(1.15);opacity:0.8;} 100%{transform:scale(1);opacity:1;} }
    .hidden { display:none !important; }

    /* ===== Login ===== */
    #login { display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; max-width:400px; margin:20px auto; padding:20px; background:#fff; border-radius:8px; box-shadow:2px 2px 8px rgba(0,0,0,0.1); }
    #login input, #login button { width:100%; margin:5px 0; padding:10px; border-radius:6px; border:1px solid #084D1F; font-size:16px; }
    #login button { background:#084D1F; color:#F5F6F2; cursor:pointer; transition:background 0.2s; }
    #login button:hover { background:#0A702A; }

    /* ===== App container ===== */
    #app { display:none; width:100%; max-width:700px; margin:0 auto; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border:1px solid #084D1F; padding:8px; text-align:center; }
    th { background:#084D1F; color:#F5F6F2; }
    tr.fullyPaid { background:#c8e6c9; }

    /* ===== Botones ===== */
    button { font-family:"Montserrat",sans-serif; padding:8px; margin:5px; border-radius:6px; border:1px solid #084D1F; font-size:16px; background:#084D1F; color:#F5F6F2; cursor:pointer; transition:background 0.2s; }
    button:hover { background:#0A702A; }

    /* ===== Totales ===== */
    #totales { margin-top:10px; font-weight:bold; }

    /* ===== Felicitaciones ===== */
    #felicitaciones { margin-top:10px; color:green; font-weight:bold; text-align:center; }

    /* ===== Responsive ===== */
    @media(max-width:600px){ input,button{width:100%; font-size:14px;} table,th,td{font-size:14px;} }
  </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <img src="https://i.ibb.co/GfJfM48J/Tilcara-logo-con-sombra.png" alt="Escudo del Club">
  <p>Cargando...</p>
</div>

<!-- Portada -->
<div class="portada">
  <img src="https://i.ibb.co/jvFxXN4M/Tilcara-portada-precios.png" alt="Encuentro Rugby Veteranos">
</div>

<!-- LOGIN -->
<div id="login">
  <h2>Login</h2>
  <input id="usuario" placeholder="Usuario">
  <input id="clave" type="password" placeholder="Clave">
  <button onclick="login()">Entrar</button>
</div>

<!-- APP -->
<div id="app">
  <h2>Bienvenido <span id="rolText"></span></h2>
  <div id="totales"></div>
  <div id="felicitaciones"></div>

  <table>
    <thead>
      <tr><th>Nombre</th><th>CUIL/CUIT</th><th>Total</th><th>Pago</th><th>Saldo</th><th>AcciÃ³n</th></tr>
    </thead>
    <tbody id="players"></tbody>
  </table>
</div>

<script>
const API_URL = '/.netlify/functions/gs-proxy';
const loader = document.getElementById("loader");

function showLoader(){ loader.classList.remove("hidden"); }
function hideLoader(){ loader.classList.add("hidden"); }

window.addEventListener("load",()=>{ showLoader(); setTimeout(()=>hideLoader(),1200); });

async function login(){
  showLoader();
  const usuario = document.getElementById("usuario").value;
  const clave = document.getElementById("clave").value;
  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:"login",usuario,clave})
    });
    const data = await res.json();
    hideLoader();
    if(data.ok){
      document.getElementById("rolText").innerText = usuario;
      document.getElementById("login").style.display="none";
      document.getElementById("app").style.display="block";
      loadPlayers();
    } else { alert("Usuario o clave incorrectos"); }
  } catch(err){ hideLoader(); alert("Error de conexiÃ³n"); console.error(err);}
}

async function loadPlayers(){
  showLoader();
  const club = document.getElementById("rolText").innerText;
  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:"getPlayers",club})
    });
    const data = await res.json();
    if(data.ok){
      renderTable(data.players);
    } else alert("Error al cargar jugadores: "+data.error);
  } catch(err){ alert("Error de red"); console.error(err); }
  finally{ hideLoader(); }
}

async function addPayment(cuil){
  const pagoInput = prompt("Ingrese nuevo pago:");
  const pago = Number(pagoInput);
  if(isNaN(pago)){ alert("Pago no vÃ¡lido"); return; }
  showLoader();
  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:"addPayment",cuil,pago})
    });
    const data = await res.json();
    if(data.ok){ loadPlayers(); } else alert("Error: "+data.error);
  } catch(err){ alert("Error de red"); console.error(err); }
  finally{ hideLoader(); }
}

function renderTable(players){
  const table = document.getElementById("players");
  table.innerHTML="";
  let total=0,pagos=0,saldos=0;
  players.forEach(p=>{
    const totalNum = Number(p.Total)||0;
    const pagoNum = Number(p.Pago)||0;
    const saldoNum = Number(p.Saldo)||(totalNum-pagoNum);
    total+=totalNum; pagos+=pagoNum; saldos+=saldoNum;

    const tr = document.createElement("tr");
    if(saldoNum===0) tr.classList.add("fullyPaid");
    tr.innerHTML = `<td>${p.Nombre} ${p.Apellido}</td>
                    <td>${p["CUIL/CUIT"]}</td>
                    <td>${totalNum}</td>
                    <td>${pagoNum}</td>
                    <td>${saldoNum}</td>
                    <td><button onclick="addPayment('${p["CUIL/CUIT"]}')">Agregar Pago</button></td>`;
    table.appendChild(tr);
  });

  document.getElementById("totales").innerText=`Total: ${total} | Pagos: ${pagos} | Saldo: ${saldos}`;
  document.getElementById("felicitaciones").innerText = (saldos===0) ? "ðŸŽ‰ Â¡Todos los jugadores de tu club ya estÃ¡n pagados!" : "";
}

// Polling cada 10s para actualizar tabla
setInterval(loadPlayers,10000);
</script>
</body>
</html>
