<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Resumen | Legends</title>
<meta name="description" content="Resumen de inscripciones y finanzas por club">
<link rel="icon" type="image/png" href="https://i.ibb.co/nN8LPTjD/logo-verde.png" />
<meta name="theme-color" content="#084D1F">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:"Montserrat",sans-serif; background:#F5F6F2; color:#084D1F; display:flex; flex-direction:column; align-items:center; width:100%; padding:0 5px; }
h1,h2,h3,h4 { text-align:center; margin:5px 0; }

.portada { display:flex; justify-content:center; align-items:center; width:100%; margin:0 auto; padding:10px 0; }
.portada img { max-width:100%; height:auto; display:block; border-radius:0 0 12px 12px; }

#loader { position: fixed; top:0; left:0; width:100%; height:100%; background:#084D1F; display:flex; justify-content:center; align-items:center; flex-direction:column; z-index:9999; }
#loader img { width:120px; height:auto; animation:pulse 1.5s infinite ease-in-out; }
#loader p { color:#F5F6F2; margin-top:20px; font-size:1.2rem; font-weight:600; letter-spacing:1px; text-align:center; }
@keyframes pulse { 0%{transform:scale(1);opacity:1;} 50%{transform:scale(1.15);opacity:0.8;} 100%{transform:scale(1);opacity:1;} }
.hidden { display:none !important; }

#login { display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; max-width:400px; margin:20px auto; padding:20px; background:#fff; border-radius:8px; box-shadow:2px 2px 8px rgba(0,0,0,0.1); text-align:center; }
#login input, #login button { width:100%; margin:5px 0; padding:12px; border-radius:6px; border:1px solid #084D1F; font-size:16px; text-align:center; }
#login button { background:#084D1F; color:#F5F6F2; cursor:pointer; transition:background 0.2s; }
#login button:hover { background:#0A702A; }

#resumen { display:none; width:100%; max-width:900px; margin:0 auto; text-align:center; }
#totales, #felicitaciones { margin:10px 0; font-weight:bold; }
#ingresos-egresos { margin-top:20px; text-align:left; }
#ingresos-egresos h2 { margin:10px 0 5px; }
#ingresos-egresos div { margin:2px 0; font-weight:500; }

table { width:100%; border-collapse:collapse; font-size:14px; margin-top:5px; }
th, td { border:1px solid #084D1F; padding:6px; text-align:center; word-wrap:break-word; }
th { background:#084D1F; color:#F5F6F2; }
tr.totalRow { font-weight:bold; background:#e0e0e0; }

@media(max-width:768px){
  table, th, td{font-size:13px; padding:5px;}
  #resumen{padding:15px;}
  #loader img{width:100px;}
  input, button{font-size:14px; padding:10px;}
}
@media(max-width:480px){
  table, th, td{font-size:12px; padding:4px;}
  #resumen{padding:10px;}
  #loader img{width:80px;}
  input, button{font-size:12px; padding:5px;}
}
</style>
</head>
<body>

<div id="loader">
  <img src="https://i.ibb.co/GfJfM48J/Tilcara-logo-con-sombra.png" alt="Escudo del Club">
  <p>Cargando resumen...</p>
</div>

<div class="portada">
  <img src="https://i.ibb.co/ym93ZMtF/Admin-Jugadores.png" alt="Encuentro Rugby Veteranos">
</div>

<div id="login">
  <h2>Login</h2>
  <input id="usuario" placeholder="Usuario">
  <input id="clave" type="password" placeholder="Clave">
  <button onclick="login()">Entrar</button>
</div>

<div id="resumen">
  <h2>Resumen de Participantes y Finanzas</h2>
  <div id="totales"></div>
  <div id="felicitaciones"></div>

  <div id="ingresos-egresos">
    <h2>Ingresos por Club</h2>
    <div id="ingresos"></div>

    <h2>Egresos</h2>
    <table id="egresosTable">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Descripción</th>
          <th>Monto</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const API_URL = '/.netlify/functions/gs-proxy';
const loader = document.getElementById("loader");
let clubesActuales = [];
let modo = null;

function showLoader(){ loader.classList.remove("hidden"); }
function hideLoader(){ loader.classList.add("hidden"); }

async function login(){
  showLoader();
  const usuario = document.getElementById("usuario").value;
  const clave = document.getElementById("clave").value;
  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:"login",usuario,clave})
    });
    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); } catch(e){ console.error("No JSON:",text); alert("Error de servidor"); hideLoader(); return; }
    hideLoader();
    if(data.ok){
      document.getElementById("login").style.display="none";
      document.getElementById("resumen").style.display="block";
      clubesActuales = data.club.split(",").map(c=>c.trim());
      modo = data.modo;
      loadResumen(clubesActuales);
    } else { alert("Usuario o clave incorrectos"); }
  } catch(e){ hideLoader(); alert("Error de conexión"); console.error(e); }
}

async function loadResumen(clubes){
  showLoader();
  let allPlayers = [];
  try{
    const promises = clubes.map(c=> fetch(API_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:"getPlayers",club:c})
    }).then(r=>r.json()));
    const results = await Promise.all(promises);
    results.forEach(d=>{ if(d.ok) allPlayers = allPlayers.concat(d.players); });

    renderResumen(allPlayers);
  } catch(e){ console.error(e); alert("Error al traer datos"); }
  finally{ hideLoader(); }
}

function formatCurrency(n){ return "$"+Number(n).toLocaleString('es-AR'); }

function renderResumen(players){
  let total=0, abonos=0, saldos=0;
  let jugadores=0, soloComida=0, invitados=0;

  players.forEach(p=>{
    const totalNum=Number(p.Total)||0;
    const abonoNum=Number(p.Abono)||0;
    const saldoNum=Number(p.Saldo)||(totalNum-abonoNum);
    total+=totalNum; abonos+=abonoNum; saldos+=saldoNum;

    if(p["Tipo Entrada"]?.toLowerCase().includes("jugador")) jugadores++;
    else if(p["Tipo Entrada"]?.toLowerCase().includes("comida")) soloComida++;
    invitados += Number(p.Invitados)||0;
  });

  document.getElementById("totales").innerText = `Total: ${formatCurrency(total)} | Abonos: ${formatCurrency(abonos)} | Saldo: ${formatCurrency(saldos)}`;
  document.getElementById("felicitaciones").innerText = `
Jugadores: ${jugadores} | Solo Comida: ${soloComida} | Invitados: ${invitados} | Total Participantes: ${jugadores+soloComida+invitados}`;

  renderIngresosEgresos(players);
}

function renderIngresosEgresos(players){
  const ingresosDiv = document.getElementById("ingresos");
  ingresosDiv.innerHTML="";
  const ingresosPorClub={};
  players.forEach(p=>{ ingresosPorClub[p.Club||"Sin Club"]=(ingresosPorClub[p.Club||"Sin Club"]||0)+Number(p.Total||0); });
  for(let c in ingresosPorClub){
    const div = document.createElement("div");
    div.innerText = `${c}: ${formatCurrency(ingresosPorClub[c])}`;
    ingresosDiv.appendChild(div);
  }

  const egresos=[]; // llenar más adelante
  const tbody=document.getElementById("egresosTable").querySelector("tbody");
  tbody.innerHTML="";
  let totalEgresos=0;
  egresos.forEach(e=>{
    totalEgresos+=Number(e.monto)||0;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${e.fecha}</td><td>${e.descripcion}</td><td>${formatCurrency(e.monto)}</td>`;
    tbody.appendChild(tr);
  });
  const trTotal=document.createElement("tr");
  trTotal.classList.add("totalRow");
  trTotal.innerHTML=`<td colspan="2">Total Egresos</td><td>${formatCurrency(totalEgresos)}</td>`;
  tbody.appendChild(trTotal);
}

if(location.protocol!=='https:'){ location.replace(`https:${location.href.substring(location.protocol.length)}`); }
</script>

</body>
</html>
