<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resumen Encuentro | Legends</title>
  <meta name="description" content="Resumen financiero y de participantes - Encuentro de veteranos" />
  <link rel="icon" href="https://i.ibb.co/nN8LPTjD/logo-verde.png" />
  <style>
    :root{
      --bg:#07160d;
      --card:#0b2b1a;
      --accent:#0a702a;
      --muted:#9fbf9a;
      --text:#e9f6ef;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: "Montserrat",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background:linear-gradient(180deg,#072015 0%, #0a2014 100%); color:var(--text);}
    .wrap{max-width:980px; margin:0 auto; padding:18px; display:flex; flex-direction:column; gap:14px;}
    header{display:flex; gap:12px; align-items:center;}
    .logo{width:56px; height:56px; border-radius:12px; background:var(--glass); display:flex;align-items:center;justify-content:center; padding:6px; box-shadow:0 6px 18px rgba(0,0,0,0.6); animation:logoPop .9s ease;}
    .logo img{width:100%; height:100%; object-fit:contain;}
    h1{font-size:1.1rem; margin:0; font-weight:800; letter-spacing:0.4px}
    p.lead{margin:0;color:var(--muted); font-size:0.9rem}

    .cards{display:grid; grid-template-columns:repeat(2,1fr); gap:10px;}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--radius); padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.5); display:flex; flex-direction:column; gap:8px;}
    .card .small{font-size:0.8rem; color:var(--muted)}
    .card .big{font-size:1.4rem; font-weight:800; color:var(--text)}
    .card.positive{border-left:4px solid #2ecc71}
    .card.negative{border-left:4px solid #e74c3c}

    .mainGrid{display:grid; grid-template-columns:1fr 380px; gap:12px;}
    .panel{background:var(--card); border-radius:12px; padding:12px; box-shadow:0 8px 30px rgba(2,6,4,0.6);}

    table{width:100%; border-collapse:collapse; color:var(--text); font-size:0.9rem;}
    th{ text-align:left; font-size:0.8rem; color:var(--muted); padding:8px 6px; }
    td{padding:8px 6px; border-top:1px dashed rgba(255,255,255,0.04)}
    .club-row{display:flex; gap:10px; align-items:center; justify-content:space-between;}
    .smallmuted{font-size:0.85rem; color:var(--muted)}

    .egreso-item{display:flex; justify-content:space-between; gap:12px; padding:8px; border-radius:10px; background:rgba(0,0,0,0.08); margin-bottom:8px; align-items:center}
    .egreso-item .monto{font-weight:700}

    .form-row{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;}
    input, select, button, textarea{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text); padding:10px; border-radius:10px; min-width:0;}
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,0.3)}
    button.primary{background:var(--accent); border:0; color:white; padding:10px 12px; cursor:pointer; border-radius:10px}
    button.ghost{background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 10px}

    @media(max-width:900px){
      .mainGrid{grid-template-columns:1fr; }
      .cards{grid-template-columns:repeat(2,1fr)}
      .wrap{padding:12px}
      .logo{width:48px;height:48px}
    }
    @media(max-width:420px){
      .cards{grid-template-columns:1fr; }
      h1{font-size:1rem}
    }

    @keyframes logoPop{ from{transform:scale(.8); opacity:0} to{transform:scale(1); opacity:1} }
    .muted-pill{background:rgba(255,255,255,0.03); padding:6px 8px; border-radius:999px; font-size:0.8rem; color:var(--muted)}

    #login { display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
    #login input { padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.05); color:var(--text); }
    #login button { padding:8px; border-radius:8px; border:none; background:var(--accent); color:#fff; cursor:pointer; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo"><img src="https://i.ibb.co/nN8LPTjD/logo-verde.png" alt="logo"></div>
    <div>
      <h1>Resumen Encuentro — Tilcara Legends</h1>
      <p class="lead">Finanzas y participantes — vista rápida</p>
    </div>
  </header>

  <!-- login -->
  <div id="login">
    <input id="usuario" placeholder="Usuario">
    <input id="clave" type="password" placeholder="Clave">
    <button onclick="login()">Entrar</button>
  </div>

  <!-- top cards -->
  <div class="cards">
    <div class="card positive">
      <div class="small">Ingresos (Abonos)</div>
      <div id="ingresos" class="big">$0</div>
      <div class="smallmuted">Total sumado por todos los clubes</div>
    </div>
    <div class="card negative">
      <div class="small">Egresos</div>
      <div id="egresosTotal" class="big">$0</div>
      <div class="smallmuted">Compras / gastos registrados</div>
    </div>
    <div class="card">
      <div class="small">Saldo Disponible</div>
      <div id="saldo" class="big">$0</div>
      <div class="smallmuted">Ingresos - Egresos</div>
    </div>
    <div class="card">
      <div class="small">Participantes</div>
      <div id="participantes" class="big">0</div>
      <div class="smallmuted" id="subcounts">Jugadores 0 • Solo comida 0 • Invitados 0</div>
    </div>
  </div>

  <div class="mainGrid">
    <!-- left: detalle por club -->
    <section class="panel">
      <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
        <div><strong>Detalle por Club</strong><div class="smallmuted">Abonos y conteos</div></div>
        <div class="muted-pill" id="loadState">Esperando login...</div>
      </div>

      <div style="overflow:auto; max-height:420px; padding-right:6px">
        <table id="clubTable" style="min-width:100%">
          <thead>
            <tr>
              <th>Club</th><th style="text-align:right">Abono</th><th style="text-align:right">Jug.</th><th style="text-align:right">Comida</th><th style="text-align:right">Inv.</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- right: egresos + formulario -->
    <aside class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div><strong>Egresos</strong><div class="smallmuted">Lista registrada</div></div>
        <div id="egresoCount" class="muted-pill">0 items</div>
      </div>
      <div id="egresosList" style="margin-top:12px; max-height:280px; overflow:auto; padding-right:6px"></div>

      <!-- Formulario solo edición -->
      <div id="egresoForm" style="display:none; margin-top:12px; border-top:1px solid rgba(255,255,255,0.1); padding-top:8px;">
        <h4>Agregar Egreso</h4>
        <div class="form-row">
          <select id="egresoClub"><option value="">Seleccionar Club</option></select>
          <input type="text" id="egresoDesc" placeholder="Descripción">
          <input type="number" id="egresoMonto" placeholder="Monto">
          <input type="date" id="egresoFecha">
          <button class="primary" onclick="addEgreso()">Agregar</button>
        </div>
      </div>
    </aside>
  </div>

  <footer style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:8px; color:var(--muted); font-size:0.9rem">
    <div>Actualizado: <span id="updatedAt">—</span></div>
  </footer>
</div>

<script>
const API = '/.netlify/functions/gs-proxy';
let clubesActuales = [];
let rawRows = [];
let egresosRows = [];
let modoUsuario = '';

const loadState = document.getElementById('loadState');
function setLoad(msg){ loadState.innerText = msg||''; }
function formatMoney(n){ return "$" + Number(n||0).toLocaleString('es-AR'); }
function nowString(){ return (new Date()).toLocaleString(); }

// LOGIN
async function login(){
  const usuario = document.getElementById('usuario').value.trim();
  const clave = document.getElementById('clave').value.trim();
  if(!usuario || !clave) { alert("Ingrese usuario y clave"); return; }
  setLoad("Verificando...");

  try{
    const res = await fetch(API,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'login', usuario, clave})
    });
    const data = await res.json();
    if(data.ok){
      modoUsuario = data.modo;
      clubesActuales = data.club.split(',').map(c=>c.trim());
      if(modoUsuario === "edicion") document.getElementById('egresoForm').style.display='block';
      // llenar dropdown clubes
      const egresoSelect = document.getElementById('egresoClub');
      egresoSelect.innerHTML = '';
      clubesActuales.forEach(c=>{
        const opt = document.createElement('option'); opt.value=c; opt.text=c;
        egresoSelect.appendChild(opt);
      });

      setLoad("Login OK, cargando datos...");
      document.getElementById('login').style.display='none';
      await loadPlayersMulti(clubesActuales);
      await loadEgresos();
    } else {
      setLoad("Login fallido");
      alert("Usuario o clave incorrectos");
    }
  } catch(err){
    console.error(err);
    setLoad("Error de conexión");
    alert("Error de conexión");
  }
}

// CARGAR DATOS POR CLUB
async function loadPlayersMulti(clubes){
  rawRows = [];
  setLoad("Cargando jugadores...");
  try{
    const promises = clubes.map(c => 
      fetch(API,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'getPlayers', club:c})
      }).then(r=>r.json())
    );
    const results = await Promise.all(promises);
    results.forEach(data => { if(data.ok && data.players) rawRows.push(...data.players); });
    setLoad("Procesando datos...");
    processAndRender();
  } catch(err){
    console.error(err);
    setLoad("Error al cargar jugadores");
  }
}

// PROCESAR Y RENDERIZAR
function processAndRender(){
  const byClub = {};
  let totalAbonos=0, totalJugadores=0, totalSoloComida=0, totalInvitados=0;

  rawRows.forEach(r=>{
    const club = r['Club'] || r['club'] || '--';
    const tipo = (r['Tipo Entrada']||'').toLowerCase();
    const invitados = Number(r['Invitados']||0);
    const abono = Number(r['Abono']||0);

    if(!byClub[club]) byClub[club]={abono:0, jugadores:0, solo:0, invitados:0};
    byClub[club].abono += abono;
    if(tipo.includes('jugador')) byClub[club].jugadores +=1;
    else if(tipo.includes('comida')) byClub[club].solo +=1;
    byClub[club].invitados += invitados;

    totalAbonos+=abono;
    if(tipo.includes('jugador')) totalJugadores++;
    else if(tipo.includes('comida')) totalSoloComida++;
    totalInvitados+=invitados;
  });

  const tbody = document.querySelector('#clubTable tbody');
  tbody.innerHTML='';
  for(const c in byClub){
    const info = byClub[c];
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${c}</td><td style="text-align:right">${formatMoney(info.abono)}</td>
      <td style="text-align:right">${info.jugadores}</td>
      <td style="text-align:right">${info.solo}</td>
      <td style="text-align:right">${info.invitados}</td>`;
    tbody.appendChild(tr);
  }

  document.getElementById('ingresos').innerText = formatMoney(totalAbonos);
  document.getElementById('saldo').innerText = formatMoney(totalAbonos - egresosRows.reduce((a,b)=>a+b.monto,0));
  document.getElementById('participantes').innerText = totalJugadores+totalSoloComida+totalInvitados;
  document.getElementById('subcounts').innerText = `Jugadores ${totalJugadores} • Solo comida ${totalSoloComida} • Invitados ${totalInvitados}`;
  document.getElementById('updatedAt').innerText = nowString();
  setLoad(`Datos actualizados, ${rawRows.length} registros`);
}

// CARGAR EGRESOS
async function loadEgresos(){
  try{
    const res = await fetch(API,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'getEgresos'})
    });
    const data = await res.json();
    if(data.ok){
      egresosRows = data.egresos.map(e=>{
        return {fecha:e['Fecha'], club:e['Club'], descripcion:e['Descripción'], monto:Number(e['Monto']||0)}
      });
      renderEgresos();
    }
  } catch(err){ console.error(err); }
}

function renderEgresos(){
  const container = document.getElementById('egresosList');
  container.innerHTML='';
  let total = 0;
  egresosRows.forEach(e=>{
    total+=e.monto;
    const div = document.createElement('div');
    div.className='egreso-item';
    div.innerHTML=`<span>${new Date(e.fecha).toLocaleDateString()} • ${e.club} • ${e.descripcion}</span><span class="monto">${formatMoney(e.monto)}</span>`;
    container.appendChild(div);
  });
  document.getElementById('egresoCount').innerText = `${egresosRows.length} items`;
  document.getElementById('egresosTotal').innerText = formatMoney(total);
  // actualizar saldo
  const ingresos = Number(document.getElementById('ingresos').innerText.replace(/[$,.]/g,''));
  document.getElementById('saldo').innerText = formatMoney(ingresos - total);
}

// AGREGAR EGRESO
async function addEgreso(){
  const club = document.getElementById('egresoClub').value;
  const desc = document.getElementById('egresoDesc').value.trim();
  const monto = Number(document.getElementById('egresoMonto').value);
  const fecha = document.getElementById('egresoFecha').value;

  if(!club || !desc || !monto || !fecha){ alert("Complete todos los campos"); return; }

  try{
    const res = await fetch(API,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'addEgreso', club, descripcion:desc, monto, fecha})
    });
    const data = await res.json();
    if(data.ok){
      document.getElementById('egresoDesc').value='';
      document.getElementById('egresoMonto').value='';
      document.getElementById('egresoFecha').value='';
      loadEgresos();
    } else alert("Error: "+data.error);
  } catch(err){ console.error(err); alert("Error de conexión"); }
}
</script>
</body>
</html>
