<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Resumen | Legends</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/nN8LPTjD/logo-verde.png">
  <style>
    body { font-family:"Montserrat",sans-serif; background:#F5F6F2; color:#084D1F; text-align:center; padding:20px;}
    #loader { display:flex; justify-content:center; align-items:center; height:100vh; }
    .stat { margin:10px 0; font-weight:bold; font-size:1.2rem; }
    #resumen { display:none; }
    input, button { padding:8px; margin:5px; font-size:14px; }
  </style>
</head>
<body>

<h1>Resumen General</h1>

<div id="login">
  <h2>Login</h2>
  <input id="usuario" placeholder="Usuario">
  <input id="clave" type="password" placeholder="Clave">
  <button onclick="login()">Entrar</button>
</div>

<div id="loader" style="display:none;">
  <p>Cargando datos...</p>
</div>

<div id="resumen">
  <div class="stat" id="totalParticipantes"></div>
  <div class="stat" id="jugadores"></div>
  <div class="stat" id="soloComida"></div>
  <div class="stat" id="invitados"></div>
  <div class="stat" id="totalesDinero"></div>
</div>

<script>
const API_URL = '/.netlify/functions/gs-proxy';
let clubesActuales = [];

function showLoader() { document.getElementById("loader").style.display="flex"; }
function hideLoader() { document.getElementById("loader").style.display="none"; }

async function login(){
  const usuario = document.getElementById("usuario").value;
  const clave = document.getElementById("clave").value;

  showLoader();
  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"login", usuario, clave })
    });
    const data = await res.json();

    if(data.ok){
      clubesActuales = data.club.split(",").map(c=>c.trim());
      document.getElementById("login").style.display="none";
      loadResumen(clubesActuales);
    } else {
      alert("Usuario o clave incorrectos");
      hideLoader();
    }
  } catch(err){
    console.error(err);
    alert("Error de conexiÃ³n");
    hideLoader();
  }
}

async function loadResumen(clubes){
  let allPlayers = [];
  try{
    const promises = clubes.map(club =>
      fetch(API_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ action:"getPlayers", club })
      }).then(r=>r.json())
    );
    const results = await Promise.all(promises);
    results.forEach(data=>{ if(data.ok) allPlayers = allPlayers.concat(data.players); });
    renderResumen(allPlayers);
  } catch(err){
    console.error(err);
    alert("Error al cargar los datos");
  }
}

function formatCurrency(num){ return "$" + Number(num).toLocaleString('es-AR'); }

function renderResumen(players){
  hideLoader();
  document.getElementById("resumen").style.display="block";

  let total=0, abonos=0, saldos=0;
  let jugadores=0, soloComida=0, invitados=0;

  players.forEach(p=>{
    const totalNum = Number(p.Total)||0;
    const abonoNum = Number(p.Abono)||0;
    const saldoNum = Number(p.Saldo)||(totalNum-abonoNum);
    total += totalNum; abonos += abonoNum; saldos += saldoNum;

    if(p["Tipo Entrada"]?.toLowerCase().includes("jugador")) jugadores++;
    else if(p["Tipo Entrada"]?.toLowerCase().includes("comida")) soloComida++;

    invitados += Number(p.Invitados)||0;
  });

  document.getElementById("totalParticipantes").innerText = `Total Participantes: ${jugadores + soloComida + invitados}`;
  document.getElementById("jugadores").innerText = `Jugadores: ${jugadores}`;
  document.getElementById("soloComida").innerText = `Solo Comida: ${soloComida}`;
  document.getElementById("invitados").innerText = `Invitados: ${invitados}`;
  document.getElementById("totalesDinero").innerText = `Total: ${formatCurrency(total)} | Abonos: ${formatCurrency(abonos)} | Saldo: ${formatCurrency(saldos)}`;
}
</script>

</body>
</html>
